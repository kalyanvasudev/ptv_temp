


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pytorchvideo.data.charades &mdash; PyTorchVideo  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  
  
  
    <link rel="canonical" href="https://pytorchvideo.org/docs/_modules/pytorchvideo/data/charades.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorchvideo.org" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorchvideo.org">Home</a>
          </li>
          <li>
            <a href="https://pytorchvideo.org/docs/tutorial_overview">Tutorials</a>
          </li>
          <li>
            <a href="https://github.com/facebookresearch/pytorchvideo/">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/models.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/model_zoo.html">Model Zoo and Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/models/index.html">Models API</a></li>
</ul>
<p class="caption"><span class="caption-text">Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_preparation.html">Data Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/data/index.html">Data API</a></li>
</ul>
<p class="caption"><span class="caption-text">Transforms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/transforms.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/transforms/index.html">Transforms API</a></li>
</ul>
<p class="caption"><span class="caption-text">Layers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/layers.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/layers/index.html">Layers API</a></li>
</ul>
<p class="caption"><span class="caption-text">Accelerator</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/accelerator.html">Overview</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
      <li>pytorchvideo.data.charades</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for pytorchvideo.data.charades</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) Facebook, Inc. and its affiliates. All Rights Reserved.</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span>
<span class="kn">from</span> <span class="nn">iopath.common.file_io</span> <span class="kn">import</span> <span class="n">g_pathmgr</span>
<span class="kn">from</span> <span class="nn">pytorchvideo.data.clip_sampling</span> <span class="kn">import</span> <span class="n">ClipSampler</span>
<span class="kn">from</span> <span class="nn">pytorchvideo.data.frame_video</span> <span class="kn">import</span> <span class="n">FrameVideo</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">MultiProcessSampler</span>


<div class="viewcode-block" id="Charades"><a class="viewcode-back" href="../../../api/data/charades.html#pytorchvideo.data.charades.Charades">[docs]</a><span class="k">class</span> <span class="nc">Charades</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">IterableDataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Action recognition video dataset for Charades stored as image frames.</span>
<span class="sd">    &lt;https://prior.allenai.org/projects/charades&gt;</span>

<span class="sd">    This dataset handles the parsing of frames, loading and clip sampling for the</span>
<span class="sd">    videos. All io reading is done with PathManager, enabling non-local storage</span>
<span class="sd">    uri&#39;s to be used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Number of classes represented by this dataset&#39;s annotated labels.</span>
    <span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="mi">157</span>

<div class="viewcode-block" id="Charades.__init__"><a class="viewcode-back" href="../../../api/data/charades.html#pytorchvideo.data.charades.Charades.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">clip_sampler</span><span class="p">:</span> <span class="n">ClipSampler</span><span class="p">,</span>
        <span class="n">video_sampler</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Sampler</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">RandomSampler</span><span class="p">,</span>
        <span class="n">transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">video_path_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">frames_per_clip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            data_path (str): Path to the data file. This file must be a space</span>
<span class="sd">                separated csv with the format:</span>
<span class="sd">                    `original_vido_id video_id frame_id path labels`</span>

<span class="sd">            clip_sampler (ClipSampler): Defines how clips should be sampled from each</span>
<span class="sd">                video. See the clip sampling documentation for more information.</span>

<span class="sd">            video_sampler (Type[torch.utils.data.Sampler]): Sampler for the internal</span>
<span class="sd">                video container. This defines the order videos are decoded and,</span>
<span class="sd">                if necessary, the distributed split.</span>

<span class="sd">            transform (Optional[Callable]): This callable is evaluated on the clip output before</span>
<span class="sd">                the clip is returned. It can be used for user defined preprocessing and</span>
<span class="sd">                augmentations to the clips. The clip output is a dictionary with the</span>
<span class="sd">                following format:</span>
<span class="sd">                    {</span>
<span class="sd">                        &#39;video&#39;: &lt;video_tensor&gt;,</span>
<span class="sd">                        &#39;label&#39;: &lt;index_label&gt; for clip-level label,</span>
<span class="sd">                        &#39;video_label&#39;: &lt;index_label&gt; for video-level label,</span>
<span class="sd">                        &#39;video_index&#39;: &lt;video_index&gt;,</span>
<span class="sd">                        &#39;clip_index&#39;: &lt;clip_index&gt;,</span>
<span class="sd">                        &#39;aug_index&#39;: &lt;aug_index&gt;, augmentation index as augmentations</span>
<span class="sd">                            might generate multiple views for one clip.</span>
<span class="sd">                    }</span>
<span class="sd">                If transform is None, the raw clip output in the above format is</span>
<span class="sd">                returned unmodified.</span>
<span class="sd">            video_path_prefix (str): prefix path to add to all paths from data_path.</span>
<span class="sd">            frames_per_clip (Optional[int]): The number of frames per clip to sample.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clip_sampler</span> <span class="o">=</span> <span class="n">clip_sampler</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path_to_videos</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_video_labels</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">_read_video_paths_and_labels</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">video_path_prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_video_sampler</span> <span class="o">=</span> <span class="n">video_sampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_to_videos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_video_sampler_iter</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialized on first call to self.__next__()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_filter</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">Charades</span><span class="o">.</span><span class="n">_sample_clip_frames</span><span class="p">,</span>
                <span class="n">frames_per_clip</span><span class="o">=</span><span class="n">frames_per_clip</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">frames_per_clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># Depending on the clip sampler type, we may want to sample multiple clips</span>
        <span class="c1"># from one video. In that case, we keep the store video, label and previous sampled</span>
        <span class="c1"># clip time in these variables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_video</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_clip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_clip_start_time</span> <span class="o">=</span> <span class="mf">0.0</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_sample_clip_frames</span><span class="p">(</span>
        <span class="n">frame_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">frames_per_clip</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            frame_indices (list): list of frame indices.</span>
<span class="sd">            frames_per+clip (int): The number of frames per clip to sample.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (list): Outputs a subsampled list with num_samples frames.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_indices</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">frames_per_clip</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">frame_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">video_sampler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_video_sampler</span>

<div class="viewcode-block" id="Charades.__next__"><a class="viewcode-back" href="../../../api/data/charades.html#pytorchvideo.data.charades.Charades.__next__">[docs]</a>    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the next clip based on the clip sampling strategy and video sampler.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A video clip with the following format if transform is None:</span>
<span class="sd">                {</span>
<span class="sd">                    &#39;video&#39;: &lt;video_tensor&gt;,</span>
<span class="sd">                    &#39;label&#39;: &lt;index_label&gt; for clip-level label,</span>
<span class="sd">                    &#39;video_label&#39;: &lt;index_label&gt; for video-level label,</span>
<span class="sd">                    &#39;video_index&#39;: &lt;video_index&gt;,</span>
<span class="sd">                    &#39;clip_index&#39;: &lt;clip_index&gt;,</span>
<span class="sd">                    &#39;aug_index&#39;: &lt;aug_index&gt;, augmentation index as augmentations</span>
<span class="sd">                        might generate multiple views for one clip.</span>
<span class="sd">                }</span>
<span class="sd">            Otherwise, the transform defines the clip output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_video_sampler_iter</span><span class="p">:</span>
            <span class="c1"># Setup MultiProcessSampler here - after PyTorch DataLoader workers are spawned.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_video_sampler_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">MultiProcessSampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_video_sampler</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_video</span><span class="p">:</span>
            <span class="n">video</span><span class="p">,</span> <span class="n">video_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_video</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">video_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_video_sampler_iter</span><span class="p">)</span>
            <span class="n">path_to_video_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_to_videos</span><span class="p">[</span><span class="n">video_index</span><span class="p">]</span>
            <span class="n">video</span> <span class="o">=</span> <span class="n">FrameVideo</span><span class="o">.</span><span class="n">from_frame_paths</span><span class="p">(</span><span class="n">path_to_video_frames</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_video</span> <span class="o">=</span> <span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">video_index</span><span class="p">)</span>

        <span class="n">clip_start</span><span class="p">,</span> <span class="n">clip_end</span><span class="p">,</span> <span class="n">clip_index</span><span class="p">,</span> <span class="n">aug_index</span><span class="p">,</span> <span class="n">is_last_clip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip_sampler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_clip_start_time</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">duration</span>
        <span class="p">)</span>
        <span class="c1"># Only load the clip once and reuse previously stored clip if there are multiple</span>
        <span class="c1"># views for augmentations to perform on the same clip.</span>
        <span class="k">if</span> <span class="n">aug_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_clip</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get_clip</span><span class="p">(</span><span class="n">clip_start</span><span class="p">,</span> <span class="n">clip_end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame_filter</span><span class="p">)</span>
        <span class="n">frames</span><span class="p">,</span> <span class="n">frame_indices</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_clip</span><span class="p">[</span><span class="s2">&quot;video&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_clip</span><span class="p">[</span><span class="s2">&quot;frame_indices&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_clip_start_time</span> <span class="o">=</span> <span class="n">clip_end</span>

        <span class="k">if</span> <span class="n">is_last_clip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_video</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_clip_start_time</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Merge unique labels from each frame into clip label.</span>
        <span class="n">labels_by_frame</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[</span><span class="n">video_index</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">frame_indices</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">frame_indices</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">sample_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;video&quot;</span><span class="p">:</span> <span class="n">frames</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">labels_by_frame</span><span class="p">,</span>
            <span class="s2">&quot;video_label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_video_labels</span><span class="p">[</span><span class="n">video_index</span><span class="p">],</span>
            <span class="s2">&quot;video_name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">video_index</span><span class="p">),</span>
            <span class="s2">&quot;video_index&quot;</span><span class="p">:</span> <span class="n">video_index</span><span class="p">,</span>
            <span class="s2">&quot;clip_index&quot;</span><span class="p">:</span> <span class="n">clip_index</span><span class="p">,</span>
            <span class="s2">&quot;aug_index&quot;</span><span class="p">:</span> <span class="n">aug_index</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sample_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">(</span><span class="n">sample_dict</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sample_dict</span></div>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<span class="k">def</span> <span class="nf">_read_video_paths_and_labels</span><span class="p">(</span>
    <span class="n">video_path_label_file</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        video_path_label_file (List[str]): a file that contains frame paths for each</span>
<span class="sd">            video and the corresponding frame label. The file must be a space separated</span>
<span class="sd">            csv of the format:</span>
<span class="sd">                `original_vido_id video_id frame_id path labels`</span>

<span class="sd">        prefix (str): prefix path to add to all paths from video_path_label_file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image_paths</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">g_pathmgr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">video_path_label_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

        <span class="c1"># Space separated CSV with format: original_vido_id video_id frame_id path labels</span>
        <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
            <span class="n">video_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;original_vido_id&quot;</span><span class="p">]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
            <span class="n">image_paths</span><span class="p">[</span><span class="n">video_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">frame_labels</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">frame_labels</span><span class="p">:</span>
                <span class="n">label_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">frame_labels</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>

            <span class="n">labels</span><span class="p">[</span><span class="n">video_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span>

    <span class="c1"># Extract image paths from dictionary and return paths and labels as list.</span>
    <span class="n">video_names</span> <span class="o">=</span> <span class="n">image_paths</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">image_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_paths</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">video_names</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">video_names</span><span class="p">]</span>
    <span class="c1"># Aggregate labels from all frames to form video-level labels.</span>
    <span class="n">video_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">label_list</span><span class="p">)))</span> <span class="k">for</span> <span class="n">label_list</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">image_paths</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">video_labels</span>
</pre></div>

             </article>
             
            </div>
            <!-- <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, PyTorchVideo contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>
 -->
          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/language_data.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->


  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorchvideo.org" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorchvideo.org">Home</a>
          </li>
          <li>
            <a href="https://pytorchvideo.org/docs/tutorial_overview">Tutorials</a>
          </li>
          <li>
            <a href="https://github.com/facebookresearch/pytorchvideo/">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>